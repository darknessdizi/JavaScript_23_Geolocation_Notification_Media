(()=>{"use strict";class t{constructor(){this.main=null,this.fieldPosts=null,this.input=null,this.popup=null,this.btnVideo=null,this.btnMicro=null,this.btnAccept=null,this.btnCancel=null,this.time=null,this.media=null,this.videoListeners=[],this.microListeners=[],this.inputListeners=[],this.popupListeners=[],this.crossListeners=[],this.acceptListeners=[]}bindToDOM(){const e=document.querySelector("body");this.main=t.addTagHTML(e,"content","main");const s=t.addTagHTML(this.main,"content-field");this.fieldPosts=t.addTagHTML(s,"content-field-posts");const i=t.addTagHTML(this.main,"content-field-input","form");this.input=t.addTagHTML(i,"field-input","input"),this.input.setAttribute("placeholder","Введите текстовое сообщение"),this.input.focus(),this.btnMicro=t.addTagHTML(i,"input-actions"),this.btnMicro.classList.add("action-micro"),this.btnAccept=t.addTagHTML(i,"input-actions"),this.btnAccept.classList.add("action-accept"),this.btnAccept.classList.add("hidden"),this.time=t.addTagHTML(i,"actions-text");t.addTagHTML(this.time,"text-time","span").textContent="00.00",this.time.classList.add("hidden"),this.btnCancel=t.addTagHTML(i,"input-actions"),this.btnCancel.classList.add("action-cancel"),this.btnCancel.classList.add("hidden"),this.btnVideo=t.addTagHTML(i,"input-actions"),this.btnVideo.classList.add("action-video"),i.addEventListener("submit",(t=>this.onPressInput(t))),this.btnMicro.addEventListener("click",(t=>this.onPressMicro(t))),this.btnVideo.addEventListener("click",(t=>this.onPressVideo(t))),this.btnCancel.addEventListener("click",(()=>this.onPressCross())),this.btnAccept.addEventListener("click",(t=>this.onPressAccept(t)))}drawFieldMedia(t,e){const s=`<${e} class="field-${e}" autoplay="" muted=""></${e}>`;t.insertAdjacentHTML("beforeend",s),this.media=t.querySelector(e),this.input.value=""}drawPopup(e="message"){this.popup=t.addTagHTML(this.main,"background-popup");const s=t.addTagHTML(this.popup,"popup","form"),i=t.addTagHTML(s,"popup-message");t.addTagHTML(i,"popup-body","p").textContent="Что-то пошло не так";t.addTagHTML(i,"popup-body","p").textContent="К сожалению, нам не удалось определить Ваше местонахождение, пожалуйста, дайте разрешение на использование геолокации, либо введите координаты вручную.";t.addTagHTML(i,"popup-body","p").textContent="Широта и долгота через запятую";const n=t.addTagHTML(s,"popup-input","input");n.setAttribute("required",""),n.setAttribute("placeholder","Пример: [51.50851, -0.12572]"),n.focus();const d=t.addTagHTML(s,"popup-control"),o=t.addTagHTML(d,"control-cancel","button");o.setAttribute("type","button"),o.textContent="Отмена";const a=t.addTagHTML(d,"control-ok","button");a.setAttribute("type","submit"),a.textContent="Ок",o.addEventListener("click",(()=>this.popup.remove())),a.addEventListener("click",(t=>this.onPopupClick(t,e))),n.addEventListener("input",(()=>n.setCustomValidity("")))}drawPopupError(e){this.popup=t.addTagHTML(this.main,"background-popup");const s=t.addTagHTML(this.popup,"popup"),i=t.addTagHTML(s,"popup-message");t.addTagHTML(i,"popup-body","p").textContent=e;const n=t.addTagHTML(s,"popup-control"),d=t.addTagHTML(n,"control-cancel","button");d.setAttribute("type","button"),d.textContent="Отмена",d.addEventListener("click",(()=>this.popup.remove()))}drawMessage(e){const s=document.createElement("div");s.classList.add("content-post"),this.fieldPosts.prepend(s);const i=t.addTagHTML(s,"content-row");t.addTagHTML(i,"post-message").textContent=this.input.value,this.input.value="";const n=t.addTagHTML(i,"post-date"),d=Date.now();n.textContent=t.getNewFormatDate(d);t.addTagHTML(s,"post-cords").textContent=`[${e}]`;const o=t.addTagHTML(s,"post-link","a"),a=e.replace(" ","");o.setAttribute("href",`http://www.google.com/maps/place/${a}`),o.setAttribute("target","_blank")}drawMedia(e,s,i){const n=document.createElement("div");n.classList.add("content-post"),this.fieldPosts.prepend(n);const d=t.addTagHTML(n,"content-row"),o=t.addTagHTML(d,`post-${i}`,i);o.setAttribute("controls",""),o.src=s,this.input.value="";const a=t.addTagHTML(d,"post-date"),r=Date.now();a.textContent=t.getNewFormatDate(r);t.addTagHTML(n,"post-cords").textContent=`[${e}]`;const c=t.addTagHTML(n,"post-link","a"),h=e.replace(" ","");c.setAttribute("href",`http://www.google.com/maps/place/${h}`),c.setAttribute("target","_blank")}static getNewFormatDate(e){const s=new Date(e),i=String(s.getFullYear()),n=t._addZero(s.getMonth()+1);return`${t._addZero(s.getDate())}.${n}.${i} ${t._addZero(s.getHours())}:${t._addZero(s.getMinutes())}`}static _addZero(t){let e=t;return e<10&&(e=`0${e}`),e}static addTagHTML(t,e=null,s="div"){const i=document.createElement(s);return i.classList.add(e),t.append(i),i}onPopupClick(t,e){this.popupListeners.forEach((s=>s.call(null,t,e)))}addPopupListeners(t){this.popupListeners.push(t)}onPressInput(t){t.preventDefault(),this.inputListeners.forEach((t=>t.call(null)))}addInputListeners(t){this.inputListeners.push(t)}onPressMicro(t){this.microListeners.forEach((e=>e.call(null,t)))}addMicroListeners(t){this.microListeners.push(t)}onPressVideo(t){this.videoListeners.forEach((e=>e.call(null,t)))}addVideoListeners(t){this.videoListeners.push(t)}onPressCross(){this.crossListeners.forEach((t=>t.call(null)))}addCrossListeners(t){this.crossListeners.push(t)}onPressAccept(){this.acceptListeners.forEach((t=>t.call(null)))}addAcceptListeners(t){this.acceptListeners.push(t)}}class e{constructor(t){this.edit=t,this.time={hours:0,minutes:0,seconds:0},this.stream=null,this.timerId=null,this.recorder=null,this.chunks=[],this.url=null,this.save=!1}init(){this.edit.bindToDOM(),this.edit.addInputListeners(this.onPressInput.bind(this)),this.edit.addMicroListeners(this.onPressMicro.bind(this)),this.edit.addVideoListeners(this.onPressVideo.bind(this)),this.edit.addPopupListeners(this.onPopupClick.bind(this)),this.edit.addCrossListeners(this.onPressCross.bind(this)),this.edit.addAcceptListeners(this.onPressAccept.bind(this))}static getCoords(){return new Promise((t=>{navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{console.log("data",e),t({latitude:e.coords.latitude,longitude:e.coords.longitude})}),(e=>{console.log("ошибка",e),t(!1)}),{timeout:3e3}):t(!1)}))}static getStringCoords(t,e){const s=String(t.latitude).split(".");let i=null;i=s.length>1?s[1].length<e?t.latitude.toFixed(s[1].length):t.latitude.toFixed(e):t.latitude;const n=String(t.longitude).split(".");let d=null;return d=n.length>1?n[1].length<e?t.longitude.toFixed(n[1].length):t.longitude.toFixed(e):t.longitude,`${i}, ${d}`}static checkCoords(t){const{value:e}=t;if(/^\[[-+]?\d{1,2}(?:\.\d+)?,\s*[-+]?\d{1,3}(?:\.\d+)?\]$/.test(e)){const[t,s]=e.split(",");return{latitude:Number(t.replace("[","").trim()),longitude:Number(s.replace("]","").trim())}}if(/^[-+]?\d{1,2}(?:\.\d+)?,\s*[-+]?\d{1,3}(?:\.\d+)?$/.test(e)){const[t,s]=e.split(",");return{latitude:Number(t.trim()),longitude:Number(s.trim())}}return t.setCustomValidity("Не верно указаны координаты"),!1}onPopupClick(t,s){const i=t.target.closest(".popup").querySelector(".popup-input");if(i.validity.valueMissing)return void i.setCustomValidity("Укажите широту и долготу согласно образца");const n=e.checkCoords(i);if(!n)return;t.preventDefault(),this.edit.popup.remove();const d=e.getStringCoords(n,5);"message"===s&&this.edit.drawMessage(d),"audio"===s&&this.edit.drawMedia(d,this.url,"audio"),"video"===s&&this.edit.drawMedia(d,this.url,"video")}async onPressInput(){const t=await e.getCoords();if(!t)return void this.edit.drawPopup();const s=e.getStringCoords(t,5);this.edit.drawMessage(s)}async mediaProcessing(t,s,i){const{target:n}=t,d=n.closest(".content-field-input");try{this.stream=await navigator.mediaDevices.getUserMedia(i)}catch(t){let e=null;return e="audio"===s?"У Вас нет разрешения на использование микрофона. Подключите микрофон и попробуйте заново.":"У Вас нет разрешения на использование вебкамеры или микрофона. Подключите устройства и попробуйте заново.",void this.edit.drawPopupError(e)}this.edit.drawFieldMedia(d,s),this.edit.media.srcObject=this.stream,this.edit.media.play(),this.changingButtons(),this.recorder=new MediaRecorder(this.stream),this.recorder.start(),this.recorder.addEventListener("start",(()=>{this.timerId=setInterval(this.secundomer.bind(this),1e3)})),this.recorder.addEventListener("dataavailable",(t=>{this.chunks.push(t.data)})),this.recorder.addEventListener("stop",(async()=>{if(this.save){const t=new Blob(this.chunks);this.url=URL.createObjectURL(t);const i=await e.getCoords();if(!i)return void this.edit.drawPopup(s);const n=e.getStringCoords(i,5);this.edit.drawMedia(n,this.url,s),this.save=!1}})),this.edit.media.addEventListener("canplay",(()=>{}))}onPressMicro(t){this.mediaProcessing(t,"audio",{audio:!0})}onPressVideo(t){this.mediaProcessing(t,"video",{video:!0,audio:!0})}secundomer(){this.time.seconds+=1,60===this.time.seconds&&(this.time.minutes+=1,this.time.seconds=0,60===this.time.minutes&&(this.time.hours+=1,this.time.minutes=0));const t=e.getStringTime(this.time.seconds),s=e.getStringTime(this.time.minutes),i=e.getStringTime(this.time.hours);0===this.time.hours?this.edit.time.children[0].textContent=`${s}.${t}`:this.edit.time.children[0].textContent=`${i}.${s}.${t}`}static getStringTime(t){let e=String(t);return e.length<2&&(e=`0${t}`),e}onPressCross(){this.recorder.stop(),this.clearData()}onPressAccept(){this.save=!0,this.onPressCross()}clearData(){this.stream.getTracks().forEach((t=>{t.stop()})),this.url=null,this.chunks=[],this.edit.media.remove(),clearTimeout(this.timerId),this.changingButtons(),this.edit.time.children[0].textContent="00.00",this.edit.input.value="",this.time={hours:0,minutes:0,seconds:0}}changingButtons(){this.edit.btnVideo.classList.toggle("hidden"),this.edit.btnMicro.classList.toggle("hidden"),this.edit.btnAccept.classList.toggle("hidden"),this.edit.btnCancel.classList.toggle("hidden"),this.edit.time.classList.toggle("hidden")}}const s=new t;new e(s).init()})();