(()=>{"use strict";class e{constructor({type:e,content:t,coords:s}={}){this.element=null,this.els={body:null,coords:null,date:null},this.init(e,t,s)}init(t,s,i){let o=document.createElement("div");o.insertAdjacentHTML("afterbegin",'<div class="timeline__post post"> <div class="post__body"></div> <footer class="post__footer footer-post"> <div class="footer-post__column"> <div class="post__coords"></div> </div> <div class="footer-post__column"> <div class="post__date"></div> </div> </footer> </div> '),this.element=o.querySelector(".post"),o=null,this.els.body=this.element.querySelector(".post__body"),this.els.coords=this.element.querySelector(".post__coords"),this.els.date=this.element.querySelector(".post__date"),this.setCoords(i),this.setDate();const n={text:e.createTextPost,audio:e.createAudioPost,video:e.createVideoPost}[t](s);this.els.body.append(n)}setCoords(e){e&&"latitude"in e?this.els.coords.textContent=`[${e.latitude}, ${e.longitude}]`:this.els.coords.classList.add("_hidden")}setDate(){const e=new Date,t=e.toLocaleDateString("ru"),s=e.toLocaleTimeString("ru",{hour:"numeric",minute:"numeric"});this.els.date.textContent=`${t} ${s}`}static createTextPost(e){const t=document.createElement("p");return t.classList.add("post__text"),t.textContent=e,t}static createAudioPost(e){const t=document.createElement("audio");return t.preload="metadata",t.controls=!0,t.src=URL.createObjectURL(e),t}static createVideoPost(e){const t=document.createElement("video");return t.preload="metadata",t.controls=!0,t.src=URL.createObjectURL(e),t}}class t{constructor({parent:e,html:t,isCircularTab:s=!0}={}){this.element=null,this.parentEl=null,this.els={form:null,btnCancel:null},this.handlers={onDocKeydown:this.onDocKeydown.bind(this)},this.isOpen=!1,this.resolve=null,this.result=null,this.initModal({parent:e,html:t,isCircularTab:s})}initModal({parent:e,html:t,isCircularTab:s}){let i=document.createElement("div");i.insertAdjacentHTML("afterbegin",t),this.element=i.querySelector(".modal-container"),i=null,this.els.form=this.element.querySelector(".form-modal"),this.els.form.addEventListener("submit",this.onFormSubmit.bind(this)),this.els.btnCancel=this.element.querySelector(".modal__btn-cancel"),this.els.btnCancel.addEventListener("click",this.onBtnCancelClick.bind(this)),this.firstEl=this.els.form.elements[0],s&&(this.lastEl=this.els.form.elements[this.els.form.elements.length-1],this.firstEl.addEventListener("keydown",this.onFirstElKeydown.bind(this)),this.lastEl.addEventListener("keydown",this.onLastElKeydown.bind(this))),this.bindToDOM(e)}onFirstElKeydown(e){"Tab"===e.key&&e.shiftKey&&(e.preventDefault(),this.lastEl.focus())}onLastElKeydown(e){"Tab"!==e.key||e.shiftKey||(e.preventDefault(),this.firstEl.focus())}onDocKeydown(e){"Escape"===e.key&&this.close()}bindToDOM(e){this.parentEl=e?"string"==typeof e?document.querySelector(e):e:document.body,this.parentEl.append(this.element)}show(){document.addEventListener("keydown",this.handlers.onDocKeydown),this.element.classList.remove("_hidden"),this.firstEl.focus(),this.isOpen=!0}hide(){document.removeEventListener("keydown",this.handlers.onDocKeydown),this.element.classList.add("_hidden"),this.isOpen=!1}onBtnCancelClick(e){e.preventDefault(),this.close()}close(){this.hide(),this.resolve(this.result)}getData(){return new Promise((e=>{this.resolve=e}))}onFormSubmit(e){e.preventDefault()}}class s extends t{constructor({html:e,params:t}){super({html:e}),this.params=t}hide(){super.hide(),this.params&&"timelineInputEl"in this.params&&this.params.timelineInputEl.focus()}}class i extends s{constructor({params:e}={}){super({html:'<div class="modal-container _hidden"> <div class="modal modal-coords"> <header class="modal__header"> <div class="modal__title">Что-то пошло не так</div> </header> <div class="modal__body"> <p class="modal__text"></p> </div> <footer class="modal__footer"> <form class="form-modal" novalidate> <div class="form-modal__data"> <label for="user-coords" class="form-modal__label">Широта и долгота через запятую:</label> <div class="form-modal__input-wrap"> <input class="form-modal__input" id="user-coords" name="coords" placeholder="xx.xxxxx, xx.xxxxx"> <div class="form-modal__err-msg _hidden"></div> </div> </div> <div class="modal__control"> <button class="modal__btn form-modal__btn-send">Опубликовать</button> <button class="modal__btn form-modal__btn-send-no-coords">Опубликовать без координат</button> <button class="modal__btn modal__btn-cancel">Не публиковать</button> </div> </form> </footer> </div> </div> ',params:e}),this.els={...this.els,text:null,form:null,input:null,btnSend:null,btnSendNoCoords:null,errMsg:null},this.result={success:null,publishWithoutCoords:null,coords:{}},this.init()}init(){this.els.text=this.element.querySelector(".modal__text"),this.els.form=this.element.querySelector(".form-modal"),this.els.input=this.element.querySelector(".form-modal__input"),this.els.input.addEventListener("input",this.hideError.bind(this)),this.els.errMsg=this.element.querySelector(".form-modal__err-msg"),this.els.btnSend=this.element.querySelector(".form-modal__btn-send"),this.els.btnSend.addEventListener("click",this.onBtnSendClick.bind(this)),this.els.btnSendNoCoords=this.element.querySelector(".form-modal__btn-send-no-coords"),this.els.btnSendNoCoords.addEventListener("click",this.onBtnSendNoCoordsClick.bind(this))}showError(e){this.els.errMsg.textContent=e,this.els.errMsg.classList.remove("_hidden")}hideError(){this.els.errMsg.classList.add("_hidden")}onBtnSendClick(){this.els.input.pattern="^\\[?-?\\d{1,2}\\.\\d{5,}, ?-?\\d{1,2}\\.\\d{5,}\\]?$",this.els.input.required=!0;if(!this.els.form.checkValidity()){let e="Ошибка";return this.els.input.validity.valueMissing?e="Введите координаты":this.els.input.validity.patternMismatch&&(e="Неверный формат"),this.showError(e),this.els.input.focus(),void this.removeVerifiableAttributes()}let e=this.els.input.value;e=e.replace(/[ \[\]]/g,"");const t=e.split(",");this.result.coords.latitude=parseFloat(t[0]),this.result.coords.longitude=parseFloat(t[1]),this.result.success=!0,this.resolve(this.result),this.removeVerifiableAttributes()}removeVerifiableAttributes(){this.els.input.required=!1,this.els.input.removeAttribute("pattern")}onBtnSendNoCoordsClick(){this.result.publishWithoutCoords=!0,this.resolve(this.result)}show(e=""){this.result.success=!1,this.result.publishWithoutCoords=!1,this.result.coords={},this.els.text.textContent=e,this.els.input.value="",this.hideError(),super.show()}close(){this.result.publishWithoutCoords=!1,super.close()}}class o extends s{constructor({params:e}={}){super({html:'<div class="modal-container _hidden"> <div class="modal modal-info"> <div class="modal__body"> <p class="modal__text"></p> </div> <footer class="modal__footer"> <form class="form-modal"> <div class="modal__control"> <button class="modal__btn modal__btn-cancel">Закрыть</button> </div> </form> </footer> </div> </div> ',params:e}),this.els={...this.els,text:null},this.init()}init(){this.els.text=this.element.querySelector(".modal__text")}show(e="Что-то пошло не так."){this.els.text.textContent=e,super.show()}}new class{constructor(){this.els={body:null,input:null,mediaDuration:null,userPanelVideoWrap:null,userPanelVideo:null,forms:{text:null,media:null},mediaStart:null,mediaStop:null,btns:{audio:null,video:null,send:null,cancel:null}},this.modals={coords:null,info:null},this.postType=null,this.recorder=null,this.isRecordStopped=!0,this.mediaStopBtn=null,this.init()}init(){this.element=document.querySelector(".timeline"),this.els.body=this.element.querySelector(".timeline__body"),this.els.forms.text=this.element.querySelector(".user-panel__form-text"),this.els.forms.text.addEventListener("submit",this.onFormTextSubmit.bind(this)),this.els.input=this.element.querySelector(".user-panel__input"),this.els.input.addEventListener("keydown",this.onInputKeypress.bind(this)),this.els.input.focus(),this.els.forms.media=this.element.querySelector(".form-media"),this.els.forms.media.addEventListener("submit",this.onFormMediaSubmit.bind(this)),this.els.mediaDuration=this.element.querySelector(".form-media__duration"),this.els.mediaStart=this.element.querySelector(".form-media__start"),this.els.mediaStop=this.element.querySelector(".form-media__stop"),this.els.btns.audio=this.element.querySelector(".form-media__btn-audio"),this.els.btns.audio.addEventListener("click",this.onBtnAudioClick.bind(this)),this.els.btns.video=this.element.querySelector(".form-media__btn-video"),this.els.btns.video.addEventListener("click",this.onBtnVideoClick.bind(this)),this.els.btns.send=this.element.querySelector(".form-media__btn-send"),this.els.btns.send.addEventListener("click",this.onBtnSendClick.bind(this)),this.els.btns.cancel=this.element.querySelector(".form-media__btn-cancel"),this.els.btns.cancel.addEventListener("click",this.onBtnCancelClick.bind(this)),this.els.userPanelVideoWrap=this.element.querySelector(".user-panel__video-wrap"),this.els.userPanelVideo=this.element.querySelector(".user-panel__video"),this.modals.coords=new i({params:{timelineInputEl:this.els.input}}),this.modals.info=new o({params:{timelineInputEl:this.els.input}})}async getCoordsAuto(){return new Promise((e=>{navigator.geolocation.getCurrentPosition((t=>{e({success:!0,coords:t.coords})}),(t=>{e({success:!1,errCode:t})}))}))}async getCoordsManual(e){const t={0:"К сожалению, ваш браузер не поддерживает определение место положения, пожалуйста, воспользуйтесь другим браузером, либо введите координаты вручную.",1:"К сожалению, нам не удалось определить ваше место положение, пожалуйста, дайте разрешение на использование геолокации, либо введите координаты вручную.",2:"К сожалению, нам не удалось определить ваше место положение, пожалуйста, проверьте ваше интернет соединение, либо введите координаты вручную.",3:null};t[3]=t[2];let s="К сожалению, нам не удалось определить ваше место положение, пожалуйста, введите координаты вручную.";e in t&&(s=t[e]),this.modals.coords.show(s);const i=await this.modals.coords.getData();return this.modals.coords.hide(),i}async getCoords(){let e={errCode:{code:0}};return navigator.geolocation&&(e=await this.getCoordsAuto(),e.success)||(e=await this.getCoordsManual(e.errCode.code)),e}async createPost({type:t,content:s}){const i=await this.getCoords();if(!i.success&&!i.publishWithoutCoords)return;const o={type:t,content:s,coords:null};i.success&&(o.coords=i.coords);const n=new e(o);this.els.body.prepend(n.element),"text"===t&&(this.els.input.value="")}async onFormTextSubmit(e){e.preventDefault()}async onInputKeypress(e){"Enter"===e.key&&(e.preventDefault(),""!==this.els.input.value&&this.createPost({type:"text",content:this.els.input.value}))}onFormMediaSubmit(e){e.preventDefault()}checkMediaSupport(){const e={success:!0,errCode:null};return navigator.mediaDevices?(window.MediaRecorder||(e.success=!1,e.errCode="noMediaRecorder"),e):(e.success=!1,e.errCode="noMediaDevices",e)}async showModalInfo(e){this.modals.info.show({noMediaDevices:"К сожалению, Ваш браузер не поддерживает функцию доступа Timeline мессенджера к аудио/видео устройствам. Пожалуйста, воспользуйтесь другим браузером.",noMediaRecorder:"К сожалению, Ваш браузер не поддерживает функцию записи аудио/видео Timeline мессенджера. Пожалуйста, воспользуйтесь другим браузером.",noMicPermission:"В Вашем браузере запрещен доступ к микрофону. Если Вы хотите сделать аудио запись, разрешите доступ к микрофону.",noCameraPermission:"В Вашем браузере запрещен доступ к веб-камере. Если Вы хотите сделать видео запись, разрешите доступ к веб-камере.",audioRecordTrouble:"Ошибка аудио записи. Проверьте, подключен ли микрофон.",videoRecordTrouble:"Ошибка видео записи. Проверьте, подключена ли веб-камера.",noPermissionSupportMic:"Ошибка аудио записи. Проверьте, подключен ли микрофон и разрешен ли к нему доступ в Вашем браузере.",noPermissionSupportCamera:"Ошибка видео записи. Проверьте, подключена ли веб-камера и разрешен ли к ней доступ в Вашем браузере."}[e]),await this.modals.info.getData()}async createStreamBlob(e){const t={audio:!0,video:!1};"video"===e&&(t.video=!0);try{let s=null;if("audio"===e)s=await navigator.mediaDevices.getUserMedia(t);else if("video"===e){const e=await this.getVideoStream();if(!e.success)throw e.err;s=e.stream,this.els.userPanelVideo.srcObject=s,this.els.userPanelVideo.play(),this.els.userPanelVideoWrap.classList.remove("_hidden")}this.recorder=new MediaRecorder(s);const i=[];this.recorder.addEventListener("start",(()=>{this.isRecordStopped=!1;let e=0;const t=setInterval((()=>{if(this.isRecordStopped)clearInterval(t);else{e+=1;const t=new Date(1970,1,1,0,0,e);this.els.mediaDuration.textContent=t.toLocaleTimeString("ru",{minute:"2-digit",second:"2-digit"})}}),1e3)})),this.recorder.addEventListener("dataavailable",(e=>{i.push(e.data)})),this.recorder.addEventListener("stop",(()=>{this.isRecordStopped=!0;const t=new Blob(i);"send"===this.mediaStopBtn&&this.createPost({type:e,content:t}),"video"===e&&(this.els.userPanelVideo.src=null,this.els.userPanelVideoWrap.classList.add("_hidden")),this.els.mediaStop.classList.add("_hidden"),this.els.mediaStart.classList.remove("_hidden"),s.getTracks().forEach((e=>e.stop()))})),this.els.mediaDuration.textContent="00:00",this.els.mediaStart.classList.add("_hidden"),this.els.mediaStop.classList.remove("_hidden"),this.recorder.start()}catch(t){const s={audio:{name:"microphone",textPermission:"noMicPermission",textRecordTrouble:"audioRecordTrouble",noPermissionSupport:"noPermissionSupportMic"},video:{name:"camera",textPermission:"noCameraPermission",textRecordTrouble:"videoRecordTrouble",noPermissionSupport:"noPermissionSupportCamera"}};try{if("denied"===(await navigator.permissions.query({name:s[e].name})).state)return void await this.showModalInfo(s[e].textPermission);await this.showModalInfo(s[e].textRecordTrouble)}catch(t){await this.showModalInfo(s[e].noPermissionSupport)}}}async onBtnAudioClick(){const e=this.checkMediaSupport();e.success?(this.postType="audio",this.createStreamBlob(this.postType)):await this.showModalInfo(e.errCode)}onBtnSendClick(){this.mediaStopBtn="send",this.recorder.stop()}onBtnCancelClick(){this.mediaStopBtn="cancel",this.recorder.stop()}async getVideoStream(){const e={success:!0,stream:null,err:null};try{return console.log("нет ошибка"),e.stream=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0}),console.log("круто"),e}catch(t){console.log("ошибка",t);try{return e.stream=await navigator.mediaDevices.getUserMedia({audio:!1,video:!0}),e}catch(t){return e.success=!1,e.err=t,e}}}async onBtnVideoClick(){const e=this.checkMediaSupport();e.success?(this.postType="video",this.createStreamBlob(this.postType)):await this.showModalInfo(e.errCode)}}})();